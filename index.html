<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Plan de Mejoramiento con IA (DBA MEN Colombia)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --accent:#22c55e; --text:#e2e8f0; --muted:#94a3b8; }
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#020617;color:var(--text);padding:1.5rem;display:flex;justify-content:center}
    .app{width:min(1200px,100%);display:grid;gap:1rem;grid-template-columns:1.1fr .9fr}
    @media(max-width:1040px){.app{grid-template-columns:1fr}}
    .card{background:rgba(15,23,42,.35);border:1px solid rgba(148,163,184,.12);border-radius:1rem;padding:1rem 1.2rem}
    .row{display:grid;gap:.6rem;grid-template-columns:1fr 1fr}
    label{font-size:.78rem;color:var(--muted)}
    input,select,textarea{width:100%;background:rgba(15,23,42,.35);border:1px solid rgba(148,163,184,.35);border-radius:.6rem;padding:.5rem .65rem;color:var(--text)}
    textarea{min-height:88px}
    .btn{border:none;border-radius:.6rem;padding:.55rem .95rem;cursor:pointer;font-size:.85rem}
    .btn-primary{background:linear-gradient(90deg,#22c55e,#16a34a);color:#020617}
    .btn-outline{background:rgba(148,163,184,.05);border:1px solid rgba(148,163,184,.3);color:var(--text)}
    .output-box{background:rgba(15,23,42,.25);border:1px dashed rgba(148,163,184,.25);border-radius:.6rem;padding:.65rem .8rem;min-height:140px;white-space:pre-wrap;font-size:.85rem;line-height:1.35}
    .badge{display:inline-flex;padding:.15rem .6rem;border-radius:999px;font-size:.72rem;border:1px solid rgba(148,163,184,.25)}
    .nivel-superior{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.4);color:#bbf7d0}
    .nivel-bajo{background:rgba(249,115,22,.12);border-color:rgba(249,115,22,.4);color:#fdba74}
    .stack{display:flex;gap:.5rem;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:.78rem}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="app">
    <!-- IZQUIERDA -->
    <div class="card">
      <h1 style="margin:.2rem 0 .4rem">Plan de Mejoramiento (DBA MEN)</h1>
      <p class="muted">Genera actividades de recuperaci√≥n con ejercicios, talleres y evaluaciones alineadas a DBA MEN Colombia.</p>

      <div class="row" style="margin-top:.5rem">
        <div>
          <label>Nombre del estudiante</label>
          <input id="nombre" placeholder="Nombre y apellido" />
        </div>
        <div>
          <label>Grado</label>
          <select id="grado">
            <option>1¬∞</option><option>2¬∞</option><option>3¬∞</option><option>4¬∞</option><option>5¬∞</option>
            <option>6¬∞</option><option>7¬∞</option><option>8¬∞</option><option>9¬∞</option><option>10¬∞</option><option>11¬∞</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:.5rem">
        <div>
          <label>√Årea</label>
          <select id="area">
            <option>Matem√°ticas</option>
            <option>Lengua Castellana</option>
            <option>Ciencias Naturales</option>
            <option>Ciencias Sociales</option>
            <option>Ingl√©s</option>
            <option>√âtica y Valores</option>
          </select>
        </div>
        <div>
          <label>Nota (0‚Äì5)</label>
          <input id="nota" type="number" min="0" max="5" step="0.01" placeholder="2.9" />
        </div>
      </div>

      <div style="margin-top:.5rem">
        <label>Temas / desempe√±os no superados</label>
        <textarea id="temas" placeholder="Ej.: lectura inferencial; fracciones; ecosistemas; pensamiento espacial; verb to be; normas de convivencia‚Ä¶"></textarea>
      </div>

      <div class="stack" style="margin-top:.6rem">
        <button class="btn btn-primary" id="btn-generar-base">Generar base (autom√°tico)</button>
        <button class="btn btn-outline" id="btn-limpiar">Limpiar</button>
        <button class="btn btn-outline" id="btn-pdf-base">PDF Base</button>
        <span id="info-nivel" class="badge">Sin nota</span>
      </div>

      <div style="margin-top:.8rem">
        <label>Actividades generadas (base)</label>
        <div id="salida" class="output-box"></div>
      </div>
    </div>

    <!-- DERECHA -->
    <div class="card">
      <h2 style="margin:.2rem 0 .6rem">Complementar con IA (DBA MEN Colombia)</h2>
      <p class="muted">La IA usar√° el texto base y los DBA del √°rea/grado para crear <b>talleres, ejercicios, problemas combinados y evaluaciones</b>.</p>

      <div class="row">
        <div>
          <label>Proveedor IA</label>
          <select id="prov">
            <option value="gemini">Gemini</option>
            <option value="openai">OpenAI</option>
          </select>
        </div>
        <div>
          <label>Modelo</label>
          <input id="modelo" placeholder="gemini-1.5-flash-latest / gpt-4o-mini" />
        </div>
      </div>

      <div class="row" style="margin-top:.5rem">
        <div>
          <label>API key (opcional para modo online)</label>
          <input id="apiKey" type="password" placeholder="tu_key_aqu√≠" />
        </div>
        <div class="stack" style="align-items:flex-end">
          <button class="btn btn-primary" id="btn-verificar" style="margin-top:1.45rem">Verificar / Cambiar modo</button>
          <span id="estado-ia" class="badge" style="margin-top:1.45rem">Modo: offline</span>
        </div>
      </div>

      <div class="stack" style="margin-top:.6rem">
        <button class="btn btn-outline" id="btn-ia">Generar con IA (talleres + ejercicios + evaluaciones)</button>
        <button class="btn btn-outline" id="btn-pdf-ia" disabled>PDF IA</button>
      </div>

      <div style="margin-top:.8rem">
        <label>Plan ampliado por IA (DBA MEN)</label>
        <div id="ia-respuesta" class="output-box"></div>
      </div>
    </div>
  </div>

  <script>
    // ======= Mapa m√≠nimo de DBA MEN (s√≠ntesis) para 1¬∞‚Äì5¬∞ =======
    // Nota: s√≠ntesis pedag√≥gicas operativas (no transcriben documentos oficiales; sirven para contextualizar el prompt).
    const DBA_MINI = {
      "Matem√°ticas": {
        "1¬∞": ["Conteo y valor posicional inicial","Suma y resta en contexto","Figuras planas b√°sicas","Medici√≥n no convencional","Patrones simples"],
        "2¬∞": ["Suma y resta con reagrupaci√≥n","Introducci√≥n a multiplicaci√≥n (repetici√≥n)","Longitud y tiempo b√°sicos","Patrones y series","Resoluci√≥n de problemas simples"],
        "3¬∞": ["Multiplicaci√≥n y divisi√≥n b√°sicas","Fracciones unitarias","Per√≠metro","Gr√°ficas de barras simples","Problemas aritm√©ticos de 1‚Äì2 pasos"],
        "4¬∞": ["Multiplicaci√≥n/divisi√≥n con n√∫meros mayores","Fracciones y decimales b√°sicos","√Årea y per√≠metro","√Ångulos y l√≠neas","Representaci√≥n de datos"],
        "5¬∞": ["Operaciones con fracciones/decimales b√°sicos","Proporcionalidad inicial","Volumen b√°sico","Coordenadas I cuadrante","Problemas multietapa"]
      },
      "Lengua Castellana": {
        "1¬∞": ["Conciencia fonol√≥gica y decodificaci√≥n","Comprensi√≥n literal de textos cortos","Producci√≥n de oraciones","Vocabulario de aula","Normas b√°sicas de escritura"],
        "2¬∞": ["Comprensi√≥n literal e inferencial inicial","Secuencias y personajes","Textos instructivos cortos","Ortograf√≠a b√°sica","Narraci√≥n breve"],
        "3¬∞": ["Comprensi√≥n inferencial b√°sica","Ideas principales y secundarias","Textos expositivos simples","Coherencia y cohesi√≥n inicial","Plan de escritura"],
        "4¬∞": ["Comprensi√≥n cr√≠tica inicial","Resumen y par√°frasis","Tipos textuales (narr., descript., expositivo)","Ortograf√≠a intermedia","Producci√≥n de p√°rrafos"],
        "5¬∞": ["Comprensi√≥n cr√≠tica y prop√≥sito del autor","Argumentaci√≥n inicial","Textos informativos m√°s extensos","Cohesi√≥n y conectores","Revisi√≥n y edici√≥n del texto"]
      },
      "Ciencias Naturales": {
        "1¬∞": ["Cuerpo y sentidos","Seres vivos vs no vivos","Partes de la planta","Agua y clima","Seguridad en experiencias"],
        "2¬∞": ["Animales y h√°bitats","Funciones del cuerpo","Estados de la materia","Cuidado ambiental","Medici√≥n b√°sica"],
        "3¬∞": ["Ciclo del agua y vida de plantas","Fuentes de energ√≠a simples","Uso de instrumentos (long., temp.)","Registros en tablas","M√©todo cient√≠fico b√°sico"],
        "4¬∞": ["Ecosistemas y cadenas tr√≥ficas","Mezclas y soluciones","Fuerza y movimiento","Indagaci√≥n guiada","Cuidado del entorno"],
        "5¬∞": ["Sistemas del cuerpo (resp., dig., circ.)","Transformaciones de energ√≠a","Interpretaci√≥n de datos y gr√°ficas","Exp. con control de variables","Acciones de salud y ambiente"]
      },
      "Ciencias Sociales": {
        "1¬∞": ["Identidad y familia","Entorno cercano","Normas de convivencia","Puntos cardinales b√°sicos","S√≠mbolos patrios"],
        "2¬∞": ["Comunidad y oficios","Mapas simples","Pasado y presente","Derechos y deberes","Cuidado de lo p√∫blico"],
        "3¬∞": ["Regiones naturales b√°sicas","Cartograf√≠a elemental","Hechos y cambios hist√≥ricos","Instituciones locales","Econom√≠a cotidiana"],
        "4¬∞": ["Regiones de Colombia","Lectura de mapas y escalas simples","Procesos hist√≥ricos clave","Participaci√≥n ciudadana","Diversidad cultural"],
        "5¬∞": ["Relaci√≥n sociedad-ambiente","Cartograf√≠a intermedia","Linea del tiempo y fuentes","Organizaci√≥n del Estado","Econom√≠a y comercio b√°sico"]
      },
      "Ingl√©s": {
        "1¬∞": ["Greetings y classroom objects","Colors y numbers 1‚Äì20","Parts of the body","Simple commands","Songs and chants"],
        "2¬∞": ["Family y food","Animals y clothes","Basic Q&A (What is this?)","Short sentences + pictures","Phonics inicial"],
        "3¬∞": ["Daily routines (present)","Prepositions (in/on/under)","Likes/Dislikes","Main idea (short texts)","Pronunciation patterns"],
        "4¬∞": ["Weather & places","Comparatives & superlatives","Giving directions","Paragraph writing (and/but/because)","Reading for detail"],
        "5¬∞": ["Past simple (went/played)","Going to (plans)","Reading: main idea & purpose","Core academic vocab","Short writing 3‚Äì4 lines"]
      },
      "√âtica y Valores": {
        "1¬∞": ["Autocuidado y empat√≠a","Normas en el aula","Resoluci√≥n pac√≠fica b√°sica","Respeto por la diferencia","Trabajo en equipo"],
        "2¬∞": ["Solidaridad y honestidad","Responsabilidad en casa/escuela","Cuidado del entorno","Di√°logo y escucha","Reglas y consecuencias"],
        "3¬∞": ["Convivencia y diversidad","Conflictos y acuerdos","Participaci√≥n y liderazgo","Cuidado de lo p√∫blico","Proyecto de vida inicial"],
        "4¬∞": ["Ciudadan√≠a y derechos","√âtica del cuidado","Resoluci√≥n de conflictos","Normas y acuerdos","Ambiente y corresponsabilidad"],
        "5¬∞": ["Justicia y respeto","Debate y argumentaci√≥n","Ciudadan√≠a digital","Cuidado socioemocional","Servicio a la comunidad"]
      }
    };

    // ======= Utilidades y estado =======
    const $ = id => document.getElementById(id);
    const elNombre=$("nombre"), elGrado=$("grado"), elArea=$("area"), elNota=$("nota"), elTemas=$("temas");
    const elSalida=$("salida"), elInfo=$("info-nivel");
    const btnBase=$("btn-generar-base"), btnLimpiar=$("btn-limpiar"), btnPDFBase=$("btn-pdf-base");

    const elProv=$("prov"), elModelo=$("modelo"), elApiKey=$("apiKey"), btnVer=$("btn-verificar");
    const btnIA=$("btn-ia"), btnPDFIA=$("btn-pdf-ia"), elEstado=$("estado-ia"), elIA=$("ia-respuesta");

    let online=false;

    function clasificarNota(n){
      if(isNaN(n))return{nivel:"Sin nota", clase:"", generar:false};
      if(n<=3.29)return{nivel:"BAJO (0‚Äì3.29)", clase:"nivel-bajo", generar:true};
      if(n<4)return{nivel:"B√ÅSICO (<4)", clase:"", generar:false};
      if(n<4.6)return{nivel:"ALTO", clase:"", generar:false};
      return{nivel:"SUPERIOR", clase:"nivel-superior", generar:false};
    }

    function getDBA(area, grado){
      const g = String(grado);
      const mapa = DBA_MINI[area];
      if(mapa && mapa[g]) return mapa[g];
      // fallback gen√©rico para 6¬∞‚Äì11¬∞ o √°reas sin mapa
      return ["Enfoque de competencias del √°rea seg√∫n MEN","Comprensi√≥n y uso de conceptos clave",
              "Resoluci√≥n de problemas contextualizados","Comunicaci√≥n de procesos y resultados",
              "Actitudes y valores en el trabajo acad√©mico"];
    }

    // ======= Base local (sin IA) =======
    function plantillasBase(area, temas, grado){
      const dba = getDBA(area, grado).slice(0,4);
      const base = temas || "los temas indicados";
      return [
        `Revisar cuaderno y evidencias de ${base}.`,
        `Lectura guiada de 1 p√°gina sobre: ${dba.join("; ")}.`,
        `Ejercicios graduados (5 √≠tems) del m√°s sencillo al m√°s complejo sobre ${base}.`,
        `Taller aplicado en contexto colombiano (familia/escuela/barrio) vinculando ${base}.`,
        `Reevaluaci√≥n corta (10 puntos) con m√≠nimo 3,3.`
      ];
    }

    btnBase.onclick = () => {
      const nota=parseFloat(elNota.value);
      const c=clasificarNota(nota);
      elInfo.textContent=c.nivel; elInfo.className="badge "+(c.clase||"");
      if(!c.generar){ elSalida.textContent="La nota no requiere plan autom√°tico."; return; }

      const acts = plantillasBase(elArea.value, elTemas.value.trim(), elGrado.value);
      const dba = getDBA(elArea.value, elGrado.value);
      elSalida.textContent =
`PLAN DE MEJORAMIENTO (BASE)
Estudiante: ${elNombre.value || "_____"}
Grado: ${elGrado.value}    √Årea: ${elArea.value}
Nota: ${elNota.value || "-"}   Nivel: ${c.nivel}

DBA MEN (s√≠ntesis) para ${elArea.value} ‚Äì ${elGrado.value}:
- ${dba.join("\n- ")}

Temas / desempe√±os no superados:
- ${elTemas.value.trim() || "Por definir"}

Actividades sugeridas:
${acts.map((a,i)=> (i+1)+". "+a).join("\n")}

Criterio de superaci√≥n:
- Entregar todas las actividades con calidad y presentar reevaluaci√≥n ‚â• 3,3.`;
    };

    btnLimpiar.onclick = () => {
      [elNombre, elNota, elTemas].forEach(x=>x.value="");
      [elSalida, elIA].forEach(x=>x.textContent="");
      elInfo.textContent="Sin nota"; elInfo.className="badge";
      online=false; elEstado.textContent="Modo: offline"; elEstado.className="badge nivel-bajo";
      btnPDFIA.disabled=true;
    };

    btnPDFBase.onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:"mm", format:"a4"});
      const txt = elSalida.textContent || "Sin plan";
      const lines = doc.splitTextToSize(txt, 180);
      doc.text(lines, 15, 20);
      doc.save("plan_base.pdf");
    };

    // ======= Verificar / modo =======
    btnVer.onclick = () => {
      const hasKey = elApiKey.value.trim().length>0;
      online = hasKey;
      if(online){
        elEstado.textContent = "Modo: online (IA conectada)";
        elEstado.className = "badge nivel-superior";
      } else {
        elEstado.textContent = "Modo: offline";
        elEstado.className = "badge nivel-bajo";
      }
    };

    // ======= IA ONLINE (Gemini / OpenAI) =======
    async function callGemini(apiKey, model, prompt){
      const models = [
        (model && model.trim()) || "gemini-1.5-flash-latest",
        "gemini-2.5-flash",
        "gemini-1.5-flash-8b"
      ];
      const body = { contents: [{ parts: [{ text: prompt }]}] };
      const base = "https://generativelanguage.googleapis.com";
      let lastErr=null;
      for(const mdl of models){
        for(const ver of ["v1","v1beta"]){
          try{
            const url = `${base}/${ver}/models/${encodeURIComponent(mdl)}:generateContent?key=${encodeURIComponent(apiKey)}`;
            const r = await fetch(url,{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)});
            const j = await r.json();
            if(!r.ok) throw new Error(j?.error?.message || "Gemini error");
            return j.candidates?.[0]?.content?.parts?.[0]?.text || "";
          }catch(e){ lastErr=e; }
        }
      }
      throw lastErr || new Error("No fue posible conectar a Gemini.");
    }

    async function callOpenAI(apiKey, model, prompt){
      const mdl = (model && model.trim()) || "gpt-4o-mini";
      const r = await fetch("https://api.openai.com/v1/chat/completions",{
        method:"POST",
        headers:{"Content-Type":"application/json","Authorization":"Bearer "+apiKey},
        body:JSON.stringify({
          model: mdl,
          messages:[
            {role:"system", content:"Eres un docente colombiano experto en curr√≠culo MEN. Genera materiales pr√°cticos alineados a DBA para primaria (y secundaria si aplica)."},
            {role:"user", content: prompt}
          ],
          temperature:0.7
        })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error?.message || "OpenAI error");
      return j.choices?.[0]?.message?.content || "";
    }

    // ======= IA OFFLINE =======
    function callOffline(prompt, area, grado){
      // Generador local sencillo con bloques pr√°cticos
      const dba = getDBA(area, grado);
      const ejemplos = area==="Matem√°ticas"
        ? `Ejercicios:
- (Nivel 1) Suma: 27 + 18 = __
- (Nivel 2) Resta: 304 ‚Äì 167 = __
- (Nivel 3) Problema: En una tienda venden 4 cajas con 6 empanadas cada una. ¬øCu√°ntas empanadas hay en total?
Problemas combinados:
1) Juan recorri√≥ 2,4 km el lunes y 1,8 km el martes. ¬øCu√°nto recorri√≥ en total? (usa decimales)
2) Una receta necesita 3/4 de taza de harina. Si haces 2 recetas, ¬øcu√°nta harina usas?
Evaluaci√≥n corta (clave al final):
1) 35 + 47 = __
2) 120 ‚Äì 58 = __
3) 3 √ó 7 = __
4) 18 √∑ 3 = __
5) Si 1/2 litro cuesta $2.000, ¬øcu√°nto cuesta 1 litro? __
Claves: 1) 82  2) 62  3) 21  4) 6  5) 4.000`
        : area==="Lengua Castellana"
        ? `Taller de lectura:
- Texto breve informativo sobre el agua en Colombia (6‚Äì8 l√≠neas).
Actividades:
1) Idea principal y 2 ideas secundarias.
2) Dos inferencias (¬øqu√© se deduce?).
3) Vocabulario: define 3 palabras nuevas.
Producci√≥n:
- Escribe un p√°rrafo (5‚Äì6 l√≠neas) resumiendo el texto con conectores (porque, adem√°s, por eso).
Evaluaci√≥n (clave de ejemplo):
- Preguntas de opci√≥n m√∫ltiple sobre idea principal, detalle y prop√≥sito del autor.`
        : area==="Ciencias Naturales"
        ? `Gu√≠a pr√°ctica:
- Experimento seguro: germinaci√≥n de fr√≠jol. Materiales, pasos, registro en tabla (d√≠a, altura, observaciones).
- Explica ciclo del agua con dibujo (evaporaci√≥n, condensaci√≥n, precipitaci√≥n).
Problemas:
1) Si una planta al sol crece 2 cm/semana y a la sombra 1 cm/semana, ¬øcu√°nto crecer√°n en 4 semanas?
Evaluaci√≥n (clave):
1) 8 cm; 4 cm.`
        : `Taller aplicado:
- Actividad de aula contextualizada en Colombia.
- 5 ejercicios graduados.
- Problemas combinados de 2‚Äì3 pasos.
Evaluaci√≥n formativa con r√∫brica (criterios y niveles).`;

      return `PLAN AMPLIADO (OFFLINE)
DBA referencia (${area} ‚Äì ${grado}):
- ${dba.join("\n- ")}

Secuencia did√°ctica:
1) Diagn√≥stico breve con 3 preguntas.
2) Recuperaci√≥n conceptual (resumen de 5‚Äì7 l√≠neas).
3) Pr√°ctica guiada (3 √≠tems).
4) Pr√°ctica independiente (5 √≠tems).
5) Socializaci√≥n y metacognici√≥n.

${ejemplos}

Criterios de valoraci√≥n:
- Pertinencia, correcci√≥n, procedimiento, comunicaci√≥n, presentaci√≥n.

Reevaluaci√≥n:
- 10 preguntas breves (m√≠nimo 3,3).`;
    }

    // ======= Prompt IA con √©nfasis en materiales pr√°cticos =======
    function buildPrompt(area, grado, nombre, baseText){
      const dba = getDBA(area, grado);
      return (
`Contexto: Sistema educativo colombiano (MEN). Genera un Plan de Mejoramiento alineado a los DBA MEN para el √°rea de ${area}, grado ${grado}.
Estudiante: ${nombre || "_____"}.

DBA MEN (s√≠ntesis/criterios de referencia):
- ${dba.join("\n- ")}

Usa el siguiente texto de base del docente:
${baseText || "(sin base)"}

Entrega en espa√±ol y formato claro con SECCIONES:
1) Diagn√≥stico (qu√© no se logr√≥, evidencias breves).
2) Prop√≥sito de recuperaci√≥n (conexi√≥n a DBA).
3) Secuencia did√°ctica (pasos).
4) Material pr√°ctico por componente:
   4.1) Ejercicios graduados (10 √≠tems con respuestas).
   4.2) Taller aplicado (contexto colombiano familia/escuela/comunidad) con instrucciones, insumos y producto final.
   4.3) Problemas combinados (m√≠nimo 5, de 2‚Äì3 pasos) con claves o procedimientos.
   4.4) Mini-proyecto o reto creativo (1) alineado a los DBA.
5) Evaluaci√≥n formativa: r√∫brica con 4 criterios √ó 4 niveles, descriptores observables.
6) Evaluaci√≥n sumativa: 10 preguntas (diversificadas) con CLAVE de respuestas.
7) Adaptaciones NEAE (sugerencias de ajuste razonable).
8) Materiales y tiempo estimado.
9) Criterios de superaci√≥n (m√≠nimo 3,3) y evidencias a entregar.

Tono: claro, docente, concreto y accionable. SIN listas vac√≠as.`
      );
    }

    // ======= IA: un click =======
    btnIA.onclick = async () => {
      const base = elSalida.textContent.trim();
      const area = elArea.value, grado = elGrado.value, nombre = elNombre.value.trim();
      const prompt = buildPrompt(area, grado, nombre, base);

      elIA.textContent = "Generando materiales con IA‚Ä¶";
      try{
        let txt="";
        if(online){
          const prov = elProv.value;
          const model = elModelo.value.trim();
          const key = elApiKey.value.trim();
          if(!key){ elIA.textContent="üîë Falta la API key para modo online. Cambia a modo offline o ingr√©sala."; return; }
          txt = (prov==="gemini")
            ? await callGemini(key, model, prompt)
            : await callOpenAI(key, model, prompt);
        } else {
          txt = callOffline(prompt, area, grado);
        }
        elIA.textContent = txt || "Sin respuesta.";
        btnPDFIA.disabled = false;
      }catch(e){
        elIA.textContent = "‚ùå Error: " + e.message;
      }
    };

btnPDFIA.onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "mm", format: "a4" });

  const txt = elIA.textContent || "Sin contenido IA";

  // Dimensiones y formato
  const pageWidth  = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const marginX = 15;
  const marginY = 20;
  const lineHeight = 7;
  const maxWidth = pageWidth - 2 * marginX;

  // Partir texto y escribirlo en m√∫ltiples p√°ginas
  const lines = doc.splitTextToSize(txt, maxWidth);
  let y = marginY;

  for (let i = 0; i < lines.length; i++) {
    if (y > pageHeight - marginY) { // Salto de p√°gina
      doc.addPage();
      y = marginY;
    }
    doc.text(lines[i], marginX, y);
    y += lineHeight;
  }

  // ----- Footer con numeraci√≥n de p√°ginas -----
  const pageCount = doc.internal.getNumberOfPages();
  doc.setFontSize(10);
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    const footer = `P√°gina ${i} de ${pageCount}`;
    // alineado a la derecha, 10 mm desde el borde inferior
    doc.text(footer, pageWidth - marginX, pageHeight - 10, { align: "right" });
  }

  doc.save("plan_mejoramiento_IA_DBA.pdf");
    };
  </script>
</body>
</html>
