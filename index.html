<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Plan de Mejoramiento con IA (DBA MEN Colombia)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --accent:#22c55e; --text:#e2e8f0; --muted:#94a3b8; --bg:#020617; --card:rgba(15,23,42,.35); }
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);padding:1.5rem;display:flex;justify-content:center}
    .app{width:min(1200px,100%);display:grid;gap:1rem;grid-template-columns:1.1fr .9fr}
    @media(max-width:1040px){.app{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid rgba(148,163,184,.12);border-radius:1rem;padding:1rem 1.2rem}
    .row{display:grid;gap:.6rem;grid-template-columns:1fr 1fr}
    label{font-size:.78rem;color:var(--muted)}
    input,select,textarea{width:100%;background:rgba(15,23,42,.35);border:1px solid rgba(148,163,184,.35);border-radius:.6rem;padding:.5rem .65rem;color:var(--text)}
    textarea{min-height:88px}
    .btn{border:none;border-radius:.6rem;padding:.55rem .95rem;cursor:pointer;font-size:.85rem}
    .btn-primary{background:linear-gradient(90deg,#22c55e,#16a34a);color:#020617}
    .btn-outline{background:rgba(148,163,184,.05);border:1px solid rgba(148,163,184,.3);color:var(--text)}
    .output-box{background:rgba(15,23,42,.25);border:1px dashed rgba(148,163,184,.25);border-radius:.6rem;padding:.65rem .8rem;min-height:140px;font-size:.85rem;line-height:1.35}
    .output-pre{white-space:pre-wrap}
    .output-html{white-space:normal}
    .badge{display:inline-flex;padding:.15rem .6rem;border-radius:999px;font-size:.72rem;border:1px solid rgba(148,163,184,.25)}
    .nivel-superior{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.4);color:#bbf7d0}
    .nivel-bajo{background:rgba(249,115,22,.12);border-color:rgba(249,115,22,.4);color:#fdba74}
    .stack{display:flex;gap:.5rem;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:.78rem}
    .small{font-size:.76rem;color:var(--muted)}
    .pill{display:inline-flex;gap:.35rem;align-items:center}
    .hr{height:1px;background:rgba(148,163,184,.18);margin:.7rem 0}

    /* Render JSON -> HTML */
    .plan h3{margin:.7rem 0 .35rem;font-size:1rem}
    .plan h4{margin:.55rem 0 .25rem;font-size:.92rem;color:var(--text)}
    .plan .kv{display:grid;grid-template-columns:140px 1fr;gap:.35rem .6rem}
    .plan .kv div{padding:.15rem 0}
    .plan ul{margin:.2rem 0 .6rem 1.1rem}
    .plan li{margin:.12rem 0}
    .plan .q{margin:.35rem 0 .55rem}
    .plan .q .t{color:var(--muted);font-size:.78rem}
    .plan table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:.55rem;border:1px solid rgba(148,163,184,.22)}
    .plan th,.plan td{border-bottom:1px solid rgba(148,163,184,.15);border-right:1px solid rgba(148,163,184,.15);padding:.4rem .45rem;vertical-align:top}
    .plan th:last-child,.plan td:last-child{border-right:none}
    .plan tr:last-child td{border-bottom:none}
    .plan th{font-size:.78rem;color:var(--muted);background:rgba(15,23,42,.35)}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="app">
    <!-- IZQUIERDA -->
    <div class="card">
      <h1 style="margin:.2rem 0 .4rem">Plan de Mejoramiento (DBA MEN)</h1>
      <p class="muted">Genera actividades de recuperación con ejercicios, talleres y evaluaciones alineadas a DBA MEN Colombia.</p>

      <div class="row" style="margin-top:.5rem">
        <div>
          <label>Nombre del estudiante</label>
          <input id="nombre" placeholder="Nombre y apellido" />
        </div>
        <div>
          <label>Grado</label>
          <select id="grado">
            <option>1°</option><option>2°</option><option>3°</option><option>4°</option><option>5°</option>
            <option>6°</option><option>7°</option><option>8°</option><option>9°</option><option>10°</option><option>11°</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:.5rem">
        <div>
          <label>Área</label>
          <select id="area">
            <option>Matemáticas</option>
            <option>Lengua Castellana</option>
            <option>Ciencias Naturales</option>
            <option>Ciencias Sociales</option>
            <option>Inglés</option>
            <option>Ética y Valores</option>
            <option>Filosofía</option>
          </select>
        </div>
        <div>
          <label>Nota (0–5)</label>
          <input id="nota" type="number" min="0" max="5" step="0.01" placeholder="2.9" />
        </div>
      </div>

      <div style="margin-top:.5rem">
        <label>Temas / desempeños no superados</label>
        <textarea id="temas" placeholder="Ej.: lectura inferencial; fracciones; ecosistemas; pensamiento espacial; verb to be; normas de convivencia…"></textarea>
      </div>

      <div class="stack" style="margin-top:.6rem">
        <button class="btn btn-primary" id="btn-generar-base">Generar base (automático)</button>
        <button class="btn btn-outline" id="btn-limpiar">Limpiar</button>
        <button class="btn btn-outline" id="btn-pdf-base">PDF Base</button>
        <span id="info-nivel" class="badge">Sin nota</span>
      </div>

      <div style="margin-top:.8rem">
        <label>Actividades generadas (base)</label>
        <div id="salida" class="output-box output-pre"></div>
      </div>
    </div>

    <!-- DERECHA -->
    <div class="card">
      <h2 style="margin:.2rem 0 .6rem">Complementar con IA (DBA MEN Colombia)</h2>
      <p class="muted">La IA usa el texto base y los DBA del área/grado para crear materiales completos. La respuesta se estructura en JSON y se renderiza en pantalla para un PDF más limpio.</p>

      <div class="row">
        <div>
          <label>Proveedor IA</label>
          <select id="prov">
            <option value="gemini">Gemini</option>
            <option value="openai">OpenAI</option>
          </select>
        </div>
        <div>
          <label>Modelo</label>
          <input id="modelo" placeholder="gemini-1.5-flash-latest / gpt-4o-mini" />
        </div>
      </div>

      <div class="row" style="margin-top:.5rem">
        <div>
          <label>API key (opcional para modo online)</label>
          <input id="apiKey" type="password" placeholder="tu_key_aquí" />
        </div>
        <div class="stack" style="align-items:flex-end">
          <button class="btn btn-primary" id="btn-verificar" style="margin-top:1.45rem">Verificar / Cambiar modo</button>
          <span id="estado-ia" class="badge" style="margin-top:1.45rem">Modo: offline</span>
        </div>
      </div>

      <div class="stack" style="margin-top:.6rem">
        <button class="btn btn-outline" id="btn-ia">Generar con IA (Talleres + ejercicios + rúbrica + evaluaciones)</button>
        <button class="btn btn-outline" id="btn-pdf-ia" disabled>PDF IA</button>
</div>

      <div class="hr"></div>

      <div style="margin-top:.2rem">
        <label>Plan ampliado por IA</label>
        <div id="ia-respuesta" class="output-box output-html"></div>
      </div>

      <p class="small" style="margin-top:.6rem">Sugerencia: para IA online, pega tu API key, verifica el modo y genera. Para offline, se crea un JSON local básico con el mismo esquema.</p>
    </div>
  </div>

  <script>
    // ======= Mapa mínimo de DBA MEN (síntesis) para 1°–5° =======
    // Síntesis pedagógicas operativas (sirven para contextualizar el prompt).
    const DBA_MINI = {
      "Matemáticas": {
        "1°": [
          "Conteo, lectura y escritura de números naturales (hasta 100)",
          "Comparación y orden (mayor/menor/igual) con material concreto",
          "Suma y resta en situaciones cotidianas (sin y con reagrupación simple)",
          "Figuras planas básicas (triángulo, cuadrado, rectángulo, círculo) y sus propiedades",
          "Patrones, secuencias y estimación con referentes del entorno"
        ],
        "2°": [
          "Suma y resta con reagrupación y verificación de resultados",
          "Introducción a la multiplicación como sumas repetidas y arreglos",
          "Medición de longitud, masa y tiempo con unidades convencionales sencillas",
          "Lectura e interpretación de tablas y pictogramas simples",
          "Resolución de problemas de 1–2 pasos con datos del contexto"
        ],
        "3°": [
          "Multiplicación y división (relación inversa) en situaciones reales",
          "Fracciones como partes de un todo (mitades, tercios, cuartos) y representación",
          "Perímetro en figuras regulares y uso de unidades",
          "Construcción y lectura de gráficas de barras",
          "Estrategias de cálculo mental y estimación para validar soluciones"
        ],
        "4°": [
          "Fracciones equivalentes y comparación; decimales en contextos de medida",
          "Operaciones con números naturales (multi‑cifra) y estrategias de cálculo",
          "Área y perímetro de rectángulos y triángulos en problemas aplicados",
          "Ángulos, paralelas/perpendiculares y clasificación de triángulos",
          "Análisis de datos: media/mediana/moda con conjuntos pequeños"
        ],
        "5°": [
          "Operaciones con fracciones y decimales (situaciones de dinero/medidas)",
          "Proporcionalidad inicial (razón) y porcentajes sencillos",
          "Volumen de prismas rectangulares con unidades cúbicas",
          "Plano cartesiano (I cuadrante) y lectura de coordenadas",
          "Modelación y resolución de problemas multietapa con explicación del procedimiento"
        ],
        "6°": [
          "Números enteros: representación, comparación y operaciones en contextos (temperatura, deudas)",
          "Fracciones y decimales: equivalencias, operaciones y problemas de medida",
          "Razón, proporción y porcentaje: interpretación y resolución de situaciones",
          "Geometría: perímetro, área y ángulos con construcciones y justificaciones",
          "Estadística y probabilidad: tablas, gráficos, promedio y eventos simples"
        ],
        "7°": [
          "Expresiones algebraicas: uso de letras, simplificación y evaluación",
          "Ecuaciones de primer grado y problemas que se modelan con ecuaciones",
          "Razón, proporcionalidad directa e inversa en contextos (escala, velocidad)",
          "Geometría: propiedades de triángulos y cuadriláteros; congruencia básica",
          "Datos: variabilidad, interpretación crítica de gráficos y conclusiones"
        ],
        "8°": [
          "Sistemas de ecuaciones lineales (métodos gráficos y algebraicos) en problemas",
          "Polinomios: operaciones, productos notables y factorización básica",
          "Funciones: relación entre variables, función lineal y su interpretación",
          "Teorema de Pitágoras y aplicaciones en problemas geométricos",
          "Probabilidad: conteo simple, eventos compuestos y simulaciones"
        ],
        "9°": [
          "Función cuadrática: representaciones, parámetros y modelación de situaciones",
          "Radicales y potencias: propiedades y simplificación en contextos",
          "Semejanza de triángulos y trigonometría inicial (razones trigonométricas)",
          "Geometría analítica: distancia, punto medio y pendiente",
          "Estadística: dispersión (rango/desviación básica) e interpretación de datos"
        ],
        "10°": [
          "Funciones polinómicas, exponenciales y logarítmicas: análisis e interpretación",
          "Trigonometría: identidades básicas y resolución de triángulos",
          "Conteo y combinatoria: permutaciones, combinaciones y principio multiplicativo",
          "Probabilidad condicional e independencia con problemas contextualizados",
          "Modelación matemática: construcción de modelos, validación y comunicación"
        ],
        "11°": [
          "Límites y continuidad: interpretación gráfica y numérica",
          "Derivada: concepto, reglas y aplicaciones (tasa de cambio, optimización)",
          "Integral básica: interpretación como acumulación y área bajo la curva",
          "Estadística: muestreo, inferencia básica y lectura crítica de resultados",
          "Proyecto de modelación: planteamiento, solución y argumentación matemática"
        ]
      },

      "Lengua Castellana": {
        "1°": [
          "Conciencia fonológica y correspondencia sonido‑letra",
          "Lectura de palabras y oraciones breves con comprensión literal",
          "Producción de oraciones con inicio‑nudo‑cierre (apoyo de imágenes)",
          "Vocabulario del entorno escolar y familiar",
          "Convenciones básicas: mayúscula inicial y punto final"
        ],
        "2°": [
          "Comprensión literal e inferencial inicial en textos cortos",
          "Secuencia de eventos y personajes en narraciones",
          "Producción de textos breves (cuento/nota/instrucciones) con claridad",
          "Ortografía básica (b/v, c/s/z inicial, uso de h frecuente) en palabras comunes",
          "Escucha y participación oral respetando turnos"
        ],
        "3°": [
          "Ideas principales y detalles en textos informativos y narrativos",
          "Inferencias sencillas: causa‑efecto, propósito y predicción",
          "Cohesión: conectores básicos (y, pero, porque, entonces) en párrafos",
          "Planificación, borrador y revisión de un texto (mínimo 2 versiones)",
          "Exposición oral corta con apoyo visual"
        ],
        "4°": [
          "Comprensión crítica inicial: intención del autor y punto de vista",
          "Resumen y paráfrasis de textos leídos",
          "Tipos textuales: narrativo, descriptivo y expositivo (estructura)",
          "Ortografía intermedia (tildes en agudas/graves/esdrújulas) y puntuación básica",
          "Producción de párrafos coherentes con tema y cierre"
        ],
        "5°": [
          "Lectura crítica: fuentes, evidencias y sesgos en textos sencillos",
          "Argumentación básica: opinión sustentada con razones y ejemplos",
          "Uso de conectores y pronombres para cohesión textual",
          "Revisión y edición: ortografía, puntuación y claridad del mensaje",
          "Producción de textos más extensos (1–2 páginas) con estructura definida"
        ],
        "6°": [
          "Comprensión e interpretación de textos literarios y no literarios (estructura y propósito)",
          "Producción de textos expositivos con organizadores (título, subtítulos, párrafos)",
          "Argumentación inicial: tesis simple, razones y ejemplos",
          "Recursos del lenguaje: metáfora, comparación, adjetivación y tono",
          "Oralidad: exposición breve, escucha activa y retroalimentación"
        ],
        "7°": [
          "Análisis de narrador, personajes y tiempo en cuentos y novelas cortas",
          "Escritura de textos argumentativos (opinión) con evidencia del texto",
          "Citación básica de fuentes y paráfrasis responsable",
          "Gramática funcional: categorías, concordancia y uso de conectores",
          "Debate guiado: normas, roles y construcción de acuerdos"
        ],
        "8°": [
          "Lectura crítica: identificar falacias simples y estrategias persuasivas",
          "Producción de textos explicativos (causa‑consecuencia, problema‑solución)",
          "Plan lector: reseña y comentario crítico de una obra",
          "Oralidad: presentación con apoyo digital y uso de recursos retóricos",
          "Escritura creativa: microcuento/poesía con revisión de estilo"
        ],
        "9°": [
          "Análisis de géneros discursivos (crónica, columna, ensayo breve)",
          "Ensayo corto: tesis, argumentos, contraargumento y conclusión",
          "Competencia mediática: verificación de información y lectura de titulares",
          "Sintaxis: oraciones simples/compuestas y puntuación avanzada",
          "Proyecto de investigación escolar: preguntas, fuentes y reporte"
        ],
        "10°": [
          "Lectura de textos filosóficos/literarios: interpretación y diálogo con ideas",
          "Ensayo argumentativo: estructura, evidencias, citas y bibliografía básica",
          "Producción multimodal: infografía, podcast o video con guion",
          "Análisis crítico de discursos (publicidad, redes, política) y sus efectos",
          "Oralidad avanzada: sustentación de un proyecto con preguntas del público"
        ],
        "11°": [
          "Lectura crítica y comparativa de obras y corrientes (intertextualidad)",
          "Escritura académica: artículo corto o monografía escolar con normas básicas",
          "Argumentación avanzada: refutación, matices y calidad de evidencia",
          "Ética de la comunicación: derechos de autor, citación y uso responsable de IA",
          "Sustentación final: defensa oral con rúbrica y autoevaluación"
        ]
      },

      "Ciencias Naturales": {
        "1°": [
          "Cuerpo humano y sentidos: cuidado y hábitos saludables",
          "Seres vivos vs. no vivos: características observables",
          "Partes de la planta y necesidades para crecer",
          "Agua y clima: observaciones simples del entorno",
          "Seguridad y normas básicas en actividades de exploración"
        ],
        "2°": [
          "Animales y hábitats: clasificación básica y adaptación",
          "Funciones del cuerpo: nutrición y movimiento",
          "Estados de la materia en experiencias sencillas",
          "Cuidado ambiental: residuos, agua y energía en casa/escuela",
          "Registro de observaciones en tablas simples"
        ],
        "3°": [
          "Ciclo del agua y su relación con la vida",
          "Fuentes de energía (luz, calor, movimiento) en el entorno",
          "Cambios de estado y mezclas (observación y comparación)",
          "Salud: prevención de enfermedades comunes",
          "Método científico básico: pregunta‑hipótesis‑prueba‑conclusión"
        ],
        "4°": [
          "Ecosistemas: cadenas tróficas y relaciones entre seres vivos",
          "Mezclas y soluciones: separación por métodos sencillos",
          "Fuerza y movimiento: empujar, halar, fricción (experimentos guiados)",
          "Ciclo de vida y reproducción en plantas y animales",
          "Indagación: control de una variable y registro de resultados"
        ],
        "5°": [
          "Sistemas del cuerpo humano (respiratorio, digestivo, circulatorio) y cuidado",
          "Energía: transformaciones (eléctrica, térmica, mecánica) en dispositivos cotidianos",
          "Materia: propiedades, cambios físicos/químicos en ejemplos simples",
          "Ambiente y salud: factores de riesgo y acciones preventivas",
          "Diseño de una indagación escolar con conclusiones sustentadas"
        ],
        "6°": [
          "Célula: estructura básica, funciones y niveles de organización",
          "Ecosistemas: ciclos biogeoquímicos y equilibrio ecológico",
          "Materia: mezclas, sustancias y métodos de separación",
          "Fuerzas: peso, fricción y representación con diagramas sencillos",
          "Indagación: variables, medición, registro y comunicación de resultados"
        ],
        "7°": [
          "Nutrición y sistemas del cuerpo: relación con salud y rendimiento",
          "Genética básica: herencia, rasgos y variabilidad",
          "Química: átomos, moléculas, enlace sencillo y reacciones cotidianas",
          "Energía y calor: cambios de temperatura y transferencia",
          "Proyecto: plantear y ejecutar un experimento con control de variables"
        ],
        "8°": [
          "Ecología: poblaciones, comunidades y dinámica de ecosistemas",
          "Química: tabla periódica, valencia y formulación básica",
          "Reacciones químicas: balanceo simple y evidencias de reacción",
          "Física: movimiento (velocidad/aceleración) y gráficos básicos",
          "Tecnología y ciencia: impacto social y ambiental de innovaciones"
        ],
        "9°": [
          "Evolución: evidencias, selección natural y biodiversidad",
          "Química: soluciones, concentración y pH en contextos",
          "Electricidad: circuitos, corriente, voltaje y resistencia",
          "Ondas: sonido y luz; fenómenos de reflexión y refracción",
          "Argumentación científica: leer datos, discutir errores y concluir"
        ],
        "10°": [
          "Biología: ADN, síntesis de proteínas y biotecnología básica",
          "Química: estequiometría y rendimiento en reacciones",
          "Física: energía, trabajo y conservación en sistemas",
          "Termodinámica básica: calor, temperatura y procesos",
          "Investigación: diseño experimental, análisis de datos y reporte"
        ],
        "11°": [
          "Biología: fisiología y homeostasis; salud pública y prevención",
          "Química: equilibrio químico, ácidos‑bases y electroquímica básica",
          "Física: campo eléctrico/magnético y aplicaciones tecnológicas",
          "Ciencia y sociedad: ética, riesgo, evidencia y toma de decisiones",
          "Proyecto final: problema, método, resultados, discusión y conclusiones"
        ]
      },

      "Ciencias Sociales": {
        "1°": [
          "Identidad, familia y comunidad: roles y normas de convivencia",
          "Ubicación básica: puntos cardinales y lugares del entorno",
          "Símbolos patrios y sentido de pertenencia",
          "Derechos y deberes en la escuela",
          "Cuidado de lo público y resolución pacífica de conflictos"
        ],
        "2°": [
          "Organización de la comunidad: oficios, servicios y normas",
          "Representación del espacio: croquis y mapas simples",
          "Pasado y presente: relatos familiares y cambios",
          "Diversidad cultural cercana y respeto",
          "Participación: acuerdos y responsabilidades"
        ],
        "3°": [
          "Regiones naturales de Colombia (nociones básicas) y clima",
          "Cartografía elemental: símbolos, leyenda y orientación",
          "Hechos y personajes históricos locales/ nacionales (nociones)",
          "Instituciones locales y formas de participación",
          "Economía cotidiana: intercambio, ahorro y consumo responsable"
        ],
        "4°": [
          "Regiones de Colombia: relieve, hidrográfica y poblamiento",
          "Lectura de mapas y escalas simples",
          "Procesos históricos clave de Colombia (nociones generales)",
          "Participación ciudadana: mecanismos básicos",
          "Diversidad étnica y cultural: reconocimiento y respeto"
        ],
        "5°": [
          "Relación sociedad‑ambiente: riesgos y cuidado del territorio",
          "Cartografía intermedia: escala, coordenadas y comparación de mapas",
          "Historia: fuentes (primarias/secundarias) y línea de tiempo",
          "Organización del Estado: ramas del poder (nociones)",
          "Economía: producción, comercio y trabajo (nociones)"
        ],
        "6°": [
          "Geografía humana: población, migraciones y urbanización",
          "Historia: civilizaciones antiguas y su legado cultural",
          "Cartografía: coordenadas, escala y lectura crítica de mapas",
          "Ciudadanía: normas, derechos humanos y convivencia",
          "Investigación social: preguntas, fuentes y análisis básico"
        ],
        "7°": [
          "Historia: Edad Media y modernidad temprana (procesos y cambios)",
          "Colombia: formación del territorio y diversidad regional",
          "Economía: oferta, demanda y sectores económicos",
          "Participación: democracia escolar y control social",
          "Lectura crítica de medios: información, opinión y evidencia"
        ],
        "8°": [
          "Historia: revoluciones (industrial, políticas) y transformaciones sociales",
          "Colombia s. XIX: independencia, repúblicas y conflictos",
          "Geografía: recursos naturales y conflictos socioambientales",
          "Ciudadanía digital: derechos, riesgos y convivencia en redes",
          "Proyecto: análisis de un problema local con propuestas"
        ],
        "9°": [
          "Colombia s. XX: violencia, urbanización y cambios políticos",
          "Mundo contemporáneo: guerras, globalización y organismos internacionales",
          "Economía: desigualdad, empleo y políticas públicas (nociones)",
          "Constitución y Estado Social de Derecho (nociones)",
          "Métodos: entrevistas/encuestas sencillas y presentación de hallazgos"
        ],
        "10°": [
          "Pensamiento histórico: causalidad, continuidad/cambio y fuentes",
          "Sistema político colombiano: instituciones y participación",
          "Economía: indicadores (PIB, inflación) e interpretación crítica",
          "Geopolítica: conflictos y cooperación regional/global",
          "Proyecto de investigación: problema, marco, método y conclusiones"
        ],
        "11°": [
          "Memoria histórica y construcción de paz: análisis de casos colombianos",
          "Derechos humanos y ciudadanía: dilemas y deliberación pública",
          "Economía y sociedad: desarrollo, sostenibilidad y bienestar",
          "Lectura crítica de discursos: propaganda, polarización y evidencia",
          "Sustentación de investigación social con fuentes y argumentos"
        ]
      },

      "Inglés": {
        "1°": [
          "Greetings, classroom objects y números básicos",
          "Colors, family y parts of the body",
          "Simple commands (stand up, sit down) y rutinas de aula",
          "Songs, chants y rimas para pronunciación inicial",
          "Vocabulario básico con imágenes (A1 inicio)"
        ],
        "2°": [
          "Animals, food, clothes y gustos (I like / I don't like)",
          "Preguntas y respuestas básicas (What is this? / It is...)",
          "Present simple en frases cortas (I have / I am)",
          "Comprensión de textos muy breves con apoyo visual",
          "Phonics y pronunciación de sonidos frecuentes"
        ],
        "3°": [
          "Daily routines (present simple) y adverbs of frequency básicos",
          "Prepositions of place (in/on/under/next to)",
          "Short reading: main idea en textos cortos",
          "Writing: sentences + connectors (and/but) con guía",
          "Speaking: role plays simples (A1)"
        ],
        "4°": [
          "Weather, places, directions (turn left/right) en contexto",
          "Comparatives/superlatives básicos",
          "Reading for detail en textos cortos (A1+)",
          "Writing: short paragraphs (3–5 sentences) con conectores",
          "Listening: identificar información específica"
        ],
        "5°": [
          "Past simple regular/irregular en historias cortas",
          "Going to / would like para planes y preferencias",
          "Reading: propósito del texto y vocabulario en contexto",
          "Writing: short texts (6–8 sentences) con revisión",
          "Speaking: presentaciones cortas y preguntas"
        ],
        "6°": [
          "Present simple vs present continuous en situaciones cotidianas",
          "There is/There are y cuantificadores (some/any/many/much)",
          "Reading: identificar idea principal y detalles en textos A2",
          "Writing: e‑mails/notes breves con estructura",
          "Speaking: describir personas, lugares y rutinas (A2)"
        ],
        "7°": [
          "Past simple y past continuous en narraciones",
          "Modal verbs (can/must/should) para normas y recomendaciones",
          "Reading: inferencias básicas y vocabulario por contexto",
          "Writing: paragraphs con topic sentence y cierre",
          "Listening/Speaking: diálogos y role plays (A2+)"
        ],
        "8°": [
          "Future forms (will/going to/present) y planes",
          "Comparatives, conditionals 0/1 en contextos",
          "Reading: textos informativos A2–B1 y resumen",
          "Writing: opinion paragraph con razones",
          "Speaking: debates guiados y presentaciones (B1 inicio)"
        ],
        "9°": [
          "Reported speech básico y relative clauses",
          "Conditionals 1/2 en situaciones reales",
          "Reading: textos B1 con propósito, tono y evidencia",
          "Writing: short essay (intro‑body‑conclusion) guiado",
          "Listening: ideas generales vs detalles (B1)"
        ],
        "10°": [
          "Passive voice y discourse markers",
          "Argumentación oral: agreeing/disagreeing, giving reasons",
          "Reading: artículos B1–B2 (identificar sesgos y evidencia)",
          "Writing: essay argumentativo con citas simples",
          "Project: presentación multimedia en inglés (B1–B2)"
        ],
        "11°": [
          "Advanced grammar review (tenses, modals, conditionals) aplicado",
          "Academic vocabulary y estrategias de lectura rápida",
          "Writing: report/essay con coherencia y corrección",
          "Speaking: debate y sustentación de proyectos",
          "Listening: conferencias cortas y toma de notas (B2 objetivo)"
        ]
      },

      "Ética y Valores": {
        "1°": [
          "Autocuidado y reconocimiento de emociones",
          "Empatía y respeto por los demás",
          "Normas básicas del aula y convivencia",
          "Resolución pacífica de conflictos (pasos simples)",
          "Trabajo en equipo y cooperación"
        ],
        "2°": [
          "Honestidad y responsabilidad en tareas y acuerdos",
          "Diálogo y escucha activa",
          "Reglas y consecuencias: toma de decisiones",
          "Cuidado del entorno y de lo público",
          "Reconocimiento de diferencias y respeto"
        ],
        "3°": [
          "Convivencia y diversidad: inclusión y trato digno",
          "Conflictos y acuerdos: mediación básica",
          "Liderazgo positivo y servicio",
          "Proyecto de vida inicial: metas y hábitos",
          "Ciudadanía: derechos/deberes en el contexto escolar"
        ],
        "4°": [
          "Ciudadanía y derechos: situaciones cotidianas",
          "Ética del cuidado: cuerpo, ambiente y relaciones",
          "Comunicación asertiva y manejo de conflictos",
          "Normas y acuerdos: construcción participativa",
          "Corresponsabilidad: familia‑escuela‑comunidad"
        ],
        "5°": [
          "Justicia y respeto: trato equitativo",
          "Debate y argumentación con respeto",
          "Ciudadanía digital: convivencia y seguridad básica",
          "Autonomía y autocontrol emocional",
          "Servicio a la comunidad: acciones solidarias"
        ],
        "6°": [
          "Identidad, autoestima y proyecto personal",
          "Toma de decisiones responsables y manejo de presiones",
          "Resolución de conflictos: negociación y mediación",
          "Derechos humanos: dignidad, igualdad y no discriminación",
          "Ciudadanía digital: huella digital, privacidad y ciberconvivencia"
        ],
        "7°": [
          "Convivencia y construcción de normas con enfoque restaurativo",
          "Ética del cuidado: salud mental y bienestar",
          "Participación democrática y liderazgo ético",
          "Prevención de violencias y cuidado de sí y del otro",
          "Dilemas éticos: razones, consecuencias y valores"
        ],
        "8°": [
          "Justicia social: equidad, inclusión y solidaridad",
          "Ética y medios: desinformación, discurso de odio y responsabilidad",
          "Afectividad y sexualidad responsable (enfoque de derechos)",
          "Proyecto de vida: metas, riesgos y protección",
          "Acción comunitaria: diagnóstico y plan de mejora"
        ],
        "9°": [
          "Ciudadanía y Constitución: convivencia, participación y control social",
          "Dilemas morales: argumentación y contraargumento",
          "Ética ambiental: sostenibilidad y consumo responsable",
          "Prevención de discriminación y promoción de derechos",
          "Proyecto: intervención ética en un problema escolar/comunitario"
        ],
        "10°": [
          "Ética aplicada: bioética, tecnología e impacto social",
          "Participación ciudadana: deliberación y acuerdos",
          "Conflicto y paz: enfoques de reconciliación y justicia",
          "Derechos, deberes y responsabilidad civil",
          "Análisis crítico de casos: evidencia, postura y conclusiones"
        ],
        "11°": [
          "Ética y proyecto de vida: sentido, propósito y bienestar",
          "Ciudadanía global: derechos humanos y convivencia intercultural",
          "Ética de la información: fuentes, sesgos, autoría y uso responsable de IA",
          "Toma de decisiones éticas en situaciones complejas",
          "Proyecto final: propuesta argumentada para un reto social"
        ]
      },

      "Filosofía": {
        "1°": [
          "Asombro y preguntas sobre el mundo (¿por qué? ¿cómo?)",
          "Distinguir hechos y opiniones con ejemplos cotidianos",
          "Escucha y diálogo: respetar turnos y razones simples",
          "Valores y decisiones: elegir entre opciones y justificar",
          "Relatos y dilemas sencillos para pensar en lo correcto"
        ],
        "2°": [
          "Preguntas filosóficas: identidad, amistad, verdad y justicia (nociones)",
          "Argumentos simples: porque… entonces… (razón y conclusión)",
          "Lenguaje: significado de palabras y ambigüedades básicas",
          "Diálogo: acuerdos, desacuerdos y respeto",
          "Dilemas cotidianos: consecuencias y empatía"
        ],
        "3°": [
          "Pensamiento crítico: comparar ideas y dar ejemplos",
          "Causa y consecuencia en explicaciones sencillas",
          "Verdad y evidencia: ¿cómo sabemos? (fuentes del entorno)",
          "Reglas para conversar: preguntar, aclarar y sintetizar",
          "Historias y preguntas sobre el bien común"
        ],
        "4°": [
          "Conceptos: libertad, responsabilidad, justicia (nociones)",
          "Razones y ejemplos para defender una idea",
          "Dilemas morales: analizar opciones y consecuencias",
          "Lectura de textos cortos y conversación guiada",
          "Cuidado del entorno: reflexión sobre acciones y deberes"
        ],
        "5°": [
          "Identidad y proyecto de vida: metas y hábitos",
          "Pensamiento crítico: detectar generalizaciones y prejuicios simples",
          "Argumentación: tesis simple, razones y conclusión",
          "Ética de la convivencia: normas y acuerdos",
          "Preguntas sobre conocimiento: experiencia, ciencia y opinión"
        ],
        "6°": [
          "Introducción a la filosofía: asombro, pregunta y reflexión",
          "Argumento: premisas, conclusión y evaluación de razones",
          "Lógica informal: ejemplos de falacias simples (ad hominem, generalización)",
          "Ética: acciones, consecuencias y normas (dilemas)",
          "Filosofía y vida cotidiana: decisiones y proyectos personales"
        ],
        "7°": [
          "Teoría del conocimiento: percepción, memoria y justificación (nociones)",
          "Lenguaje y significado: ambigüedad, metáfora y definición",
          "Ética y ciudadanía: justicia, derechos y deberes (nociones)",
          "Pensamiento crítico: evaluar fuentes y evidencias",
          "Escritura filosófica breve: pregunta, postura y razones"
        ],
        "8°": [
          "Historia de la filosofía: Grecia y Edad Media (ideas centrales)",
          "Antropología filosófica: ser humano, cultura y libertad",
          "Lógica: validez, ejemplos y contraejemplos",
          "Ética aplicada: convivencia, redes y responsabilidad",
          "Debate guiado: argumentos, contraargumentos y acuerdos"
        ],
        "9°": [
          "Modernidad: racionalismo/empirismo (nociones) y su impacto",
          "Filosofía política: poder, Estado y democracia (nociones)",
          "Dilemas éticos complejos: criterios y justificación",
          "Pensamiento crítico: sesgos, falacias y evidencia",
          "Ensayo breve: tesis, argumentos, objeción y respuesta"
        ],
        "10°": [
          "Filosofía contemporánea: lenguaje, ciencia y sociedad (nociones)",
          "Ética: teorías (deontología, utilitarismo, virtud) en casos",
          "Filosofía política: libertad, justicia y derechos humanos (nociones)",
          "Argumentación avanzada: evaluar evidencia y refutar con respeto",
          "Investigación filosófica: preguntas, fuentes y escrito argumentativo"
        ],
        "11°": [
          "Problemas actuales: tecnología, IA, bioética y sostenibilidad (análisis)",
          "Epistemología: ciencia, verdad, método y límites del conocimiento",
          "Filosofía del lenguaje y la comunicación: discurso, poder y medios",
          "Proyecto de vida y sentido: identidad, propósito y responsabilidad",
          "Ensayo final o proyecto: postura argumentada con fuentes y citas básicas"
        ]
      }
    };

    // ======= Utilidades y estado =======
    const $ = id => document.getElementById(id);
    const elNombre=$("nombre"), elGrado=$("grado"), elArea=$("area"), elNota=$("nota"), elTemas=$("temas");
    const elSalida=$("salida"), elInfo=$("info-nivel");
    const btnBase=$("btn-generar-base"), btnLimpiar=$("btn-limpiar"), btnPDFBase=$("btn-pdf-base");

    const elProv=$("prov"), elModelo=$("modelo"), elApiKey=$("apiKey"), btnVer=$("btn-verificar");
    const btnIA=$("btn-ia"), btnPDFIA=$("btn-pdf-ia"), elEstado=$("estado-ia"), elIA=$("ia-respuesta");
        let online=false;
    let iaData=null; // JSON final de IA

    function formatDateISO(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function clasificarNota(n){
      if(isNaN(n))return{nivel:"Sin nota", clase:"", generar:false};
      if(n<=3.29)return{nivel:"BAJO (0–3.29)", clase:"nivel-bajo", generar:true};
      if(n<4)return{nivel:"BÁSICO (<4)", clase:"", generar:false};
      if(n<4.6)return{nivel:"ALTO", clase:"", generar:false};
      return{nivel:"SUPERIOR", clase:"nivel-superior", generar:false};
    }

    function getDBA(area, grado){
      const g = String(grado);
      const mapa = DBA_MINI[area];
      if(mapa && mapa[g]) return mapa[g];
      // fallback genérico para 6°–11° o áreas sin mapa
      return [
        "Enfoque de competencias del área según MEN",
        "Comprensión y uso de conceptos clave",
        "Resolución de problemas contextualizados",
        "Comunicación de procesos y resultados",
        "Actitudes y valores en el trabajo académico"
      ];
    }

    // ======= Base local (sin IA) =======
    function plantillasBase(area, temas, grado){
      const dba = getDBA(area, grado).slice(0,4);
      const base = temas || "los temas indicados";
      return [
        `Revisar cuaderno y evidencias de ${base}.`,
        `Lectura guiada de 1 página sobre: ${dba.join("; ")}.`,
        `Ejercicios graduados (5 ítems) del más sencillo al más complejo sobre ${base}.`,
        `Taller aplicado en contexto colombiano (familia/escuela/barrio) vinculando ${base}.`,
        `Reevaluación corta (10 puntos) con mínimo 3,3.`
      ];
    }

    btnBase.onclick = () => {
      const nota=parseFloat(elNota.value);
      const c=clasificarNota(nota);
      elInfo.textContent=c.nivel; elInfo.className="badge "+(c.clase||"");
      if(!c.generar){ elSalida.textContent="La nota no requiere plan automático."; return; }

      const acts = plantillasBase(elArea.value, elTemas.value.trim(), elGrado.value);
      const dba = getDBA(elArea.value, elGrado.value);
      elSalida.textContent =
`PLAN DE MEJORAMIENTO (BASE)
Estudiante: ${elNombre.value || "_____"}
Grado: ${elGrado.value}    Área: ${elArea.value}
Nota: ${elNota.value || "-"}   Nivel: ${c.nivel}

DBA MEN (síntesis) para ${elArea.value} – ${elGrado.value}:
- ${dba.join("\n- ")}

Temas / desempeños no superados:
- ${elTemas.value.trim() || "Por definir"}

Actividades sugeridas:
${acts.map((a,i)=> (i+1)+". "+a).join("\n")}

Criterio de superación:
- Entregar todas las actividades con calidad y presentar reevaluación ≥ 3,3.`;
    };

    btnLimpiar.onclick = () => {
      [elNombre, elNota, elTemas].forEach(x=>x.value="");
      elSalida.textContent="";
      elIA.innerHTML="";
      elInfo.textContent="Sin nota"; elInfo.className="badge";
      online=false;
      elEstado.textContent="Modo: offline";
      elEstado.className="badge nivel-bajo";
      iaData=null;
      btnPDFIA.disabled=true; };

    btnPDFBase.onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:"mm", format:"a4"});

      const txt = elSalida.textContent || "Sin plan";
      const pageWidth  = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const marginX = 15;
      const marginY = 18;
      const maxWidth = pageWidth - 2*marginX;
      const lineH = 5.3;

      const lines = doc.splitTextToSize(txt, maxWidth);
      let y = marginY;

      doc.setFont("helvetica","normal");
      doc.setFontSize(10.5);

      for(const ln of lines){
        if(y > pageHeight - marginY){
          doc.addPage();
          y = marginY;
        }
        doc.text(ln, marginX, y);
        y += lineH;
      }

      const pageCount = doc.internal.getNumberOfPages();
      doc.setFontSize(9.5);
      for(let i=1;i<=pageCount;i++){
        doc.setPage(i);
        doc.text(`Página ${i} de ${pageCount}`, pageWidth - marginX, pageHeight - 10, { align:"right" });
      }

      doc.save("plan_base.pdf");
    };

    // ======= Verificar / modo =======
    btnVer.onclick = () => {
      const hasKey = elApiKey.value.trim().length>0;
      online = hasKey;
      if(online){
        elEstado.textContent = "Modo: online (IA conectada)";
        elEstado.className = "badge nivel-superior";
      } else {
        elEstado.textContent = "Modo: offline";
        elEstado.className = "badge nivel-bajo";
      }
    };

    // ======= IA ONLINE (Gemini / OpenAI) =======
    async function callGemini(apiKey, model, prompt){
      const models = [
        (model && model.trim()) || "gemini-1.5-flash-latest",
        "gemini-2.5-flash",
        "gemini-1.5-flash-8b"
      ];
      const base = "https://generativelanguage.googleapis.com";
      let lastErr=null;

      // Base request: menor temperatura para reducir errores de formato
      const bodyBase = {
        contents: [{ parts: [{ text: prompt }]}],
        generationConfig: { temperature: 0.2 }
      };

      for(const mdl of models){
        for(const ver of ["v1","v1beta"]){
          const url = `${base}/${ver}/models/${encodeURIComponent(mdl)}:generateContent?key=${encodeURIComponent(apiKey)}`;
          try{
            // Intento 1: pedir salida tipo JSON (si está soportado)
            let r = await fetch(url,{
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body: JSON.stringify({
                ...bodyBase,
                generationConfig: { ...bodyBase.generationConfig, responseMimeType: "application/json" }
              })
            });
            let j = await r.json();
            if(!r.ok){
              // Intento 2: sin responseMimeType (compatibilidad)
              r = await fetch(url,{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body: JSON.stringify(bodyBase)
              });
              j = await r.json();
              if(!r.ok) throw new Error(j?.error?.message || "Gemini error");
            }
            return j.candidates?.[0]?.content?.parts?.[0]?.text || "";
          }catch(e){ lastErr=e; }
        }
      }
      throw lastErr || new Error("No fue posible conectar a Gemini.");
    }

    async function callOpenAI(apiKey, model, prompt){
      const mdl = (model && model.trim()) || "gpt-4o-mini";
      const r = await fetch("https://api.openai.com/v1/chat/completions",{
        method:"POST",
        headers:{"Content-Type":"application/json","Authorization":"Bearer "+apiKey},
        body:JSON.stringify({
          model: mdl,
          messages:[
            {role:"system", content:"Eres un docente colombiano experto en currículo MEN. Respondes exactamente con el JSON solicitado."},
            {role:"user", content: prompt}
          ],
          response_format: { type: "json_object" },
          temperature:0.2
        })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error?.message || "OpenAI error");
      return j.choices?.[0]?.message?.content || "";
    }

    // ======= Extractor robusto de JSON (si el modelo se sale del formato) =======
    function extractJson(text){
      if(!text) throw new Error("Respuesta vacía.");
      const s = String(text).trim();

      // Caso ideal: ya es JSON puro
      if(s.startsWith("{") && s.endsWith("}")){
        return s;
      }

      // Buscar primer objeto JSON balanceando llaves, respetando strings
      const start = s.indexOf("{");
      if(start < 0) throw new Error("No se encontró un objeto JSON en la respuesta.");

      let inStr = false;
      let esc = false;
      let depth = 0;

      for(let i=start;i<s.length;i++){
        const ch = s[i];
        if(inStr){
          if(esc){ esc = false; continue; }
          if(ch === "\\"){ esc = true; continue; }
          if(ch === '"'){ inStr = false; continue; }
        } else {
          if(ch === '"'){ inStr = true; continue; }
          if(ch === "{"){ depth++; }
          if(ch === "}"){
            depth--;
            if(depth === 0){
              return s.slice(start, i+1);
            }
          }
        }
      }
      throw new Error("No fue posible extraer un JSON completo (llaves no balanceadas).");
    }

    
    // ======= Limpieza + auto-corrección si el JSON viene con errores =======
    function cleanJsonString(s){
      if(!s) return "";
      let t = String(s).trim();
      // BOM / caracteres raros
      t = t.replace(/\uFEFF/g, "");
      // Comillas tipográficas
      t = t.replace(/[“”]/g, '"').replace(/[‘’]/g, "'");
      // Comas colgantes
      t = t.replace(/,\s*([}\]])/g, "$1");
      return t;
    }
    // ======= Reparación local de JSON (cuando el modelo se "come" comas o mete saltos de línea en strings) =======
    function escapeNewlinesInStrings(str){
      let out = "";
      let inStr = false;
      let esc = false;
      for(let i=0;i<str.length;i++){
        const ch = str[i];
        if(inStr){
          if(esc){ out += ch; esc = false; continue; }
          if(ch === "\\"){ out += ch; esc = true; continue; }
          if(ch === '"'){ out += ch; inStr = false; continue; }
          if(ch === "\n"){ out += "\\n"; continue; }
          if(ch === "\r"){ out += "\\r"; continue; }
          out += ch;
          continue;
        }else{
          if(ch === '"'){ inStr = true; out += ch; continue; }
          out += ch;
        }
      }
      return out;
    }

    function insertMissingCommas(str){
      let out = "";
      let inStr = false;
      let esc = false;

      const isWS = (c)=> c===" " || c==="\n" || c==="\r" || c==="\t";
      const isDigit = (c)=> c>="0" && c<="9";
      const isAlpha = (c)=> /[A-Za-z]/.test(c);
      const isValueStart = (c)=> c==='"' || c==="{" || c==="[" || c==="-" || isDigit(c) || c==="t" || c==="f" || c==="n";

      let lastSig = "start"; // "value" | "comma" | "colon" | "lbrace" | "lbracket" | "start"

      let i = 0;
      while(i < str.length){
        const ch = str[i];

        if(inStr){
          out += ch;
          if(esc){ esc = false; i++; continue; }
          if(ch === "\\"){ esc = true; i++; continue; }
          if(ch === '"'){ inStr = false; lastSig = "value"; i++; continue; }
          i++;
          continue;
        }

        if(isWS(ch)){ out += ch; i++; continue; }

        // Caso típico del error: faltó una coma entre elementos (especialmente en arrays)
        if(isValueStart(ch) && lastSig === "value"){
          out += ",";
          lastSig = "comma";
          continue; // no consumimos 'ch' todavía
        }

        if(ch === '"'){ inStr = true; out += ch; i++; continue; }

        // Puntuación JSON
        if(ch === "{"){ out += ch; lastSig = "lbrace"; i++; continue; }
        if(ch === "["){ out += ch; lastSig = "lbracket"; i++; continue; }
        if(ch === "}"){ out += ch; lastSig = "value"; i++; continue; }
        if(ch === "]"){ out += ch; lastSig = "value"; i++; continue; }
        if(ch === ":"){ out += ch; lastSig = "colon"; i++; continue; }
        if(ch === ","){ out += ch; lastSig = "comma"; i++; continue; }

        // Números
        if(ch === "-" || isDigit(ch)){
          let j = i + 1;
          while(j < str.length && /[0-9eE\+\-\.]/.test(str[j])) j++;
          out += str.slice(i, j);
          lastSig = "value";
          i = j;
          continue;
        }

        // Literales (true/false/null)
        if(isAlpha(ch)){
          let j = i + 1;
          while(j < str.length && isAlpha(str[j])) j++;
          out += str.slice(i, j);
          lastSig = "value";
          i = j;
          continue;
        }

        out += ch;
        i++;
      }
      return out;
    }

    function repairJsonSyntax(s){
      let t = String(s || "").trim();
      // Normalizaciones útiles antes de parsear
      t = escapeNewlinesInStrings(t);
      // Comas colgantes
      t = t.replace(/,\s*([}\]])/g, "$1");
      // Insertar comas faltantes entre valores contiguos
      t = insertMissingCommas(t);
      // Reaplicar por si el insert dejó alguna colgante
      t = t.replace(/,\s*([}\]])/g, "$1");
      return t;
    }


    async function parseJsonWithAutoFix(rawText, onlineCtx){
      // onlineCtx: { online, prov, key, model }
      const raw = String(rawText || "");
      let jsonStr = cleanJsonString(extractJson(raw));
      try{
        return JSON.parse(jsonStr);
      }catch(err){
        // Reparación local (sin volver a llamar a la IA)
        try{
          const repaired = repairJsonSyntax(jsonStr);
          return JSON.parse(repaired);
        }catch(_e){
          // si falla, seguimos con el auto-fix por IA
        }

        // Intento automático: pedir al modelo que entregue el mismo contenido pero como JSON válido
        if(onlineCtx && onlineCtx.online && onlineCtx.key){
          const fixPrompt =
`Tu respuesta anterior NO es un JSON válido. Corrígela y devuélvela como un único objeto JSON válido.
Reglas:
- Devuelve SOLO JSON, sin texto adicional.
- No inventes nuevas secciones: conserva exactamente las mismas llaves y la misma estructura.
- Solo corrige errores de sintaxis (comas, comillas, saltos de línea en strings, etc.).
Texto a corregir:
${raw}`;
          const fixedTxt = (onlineCtx.prov==="gemini")
            ? await callGemini(onlineCtx.key, onlineCtx.model, fixPrompt)
            : await callOpenAI(onlineCtx.key, onlineCtx.model, fixPrompt);
          const fixedJson = cleanJsonString(extractJson(fixedTxt));
          return JSON.parse(repairJsonSyntax(fixedJson));
        }
        throw err;
      }
    }

// ======= Prompt (Prompt6) -> salida estricta en JSON =======
    function buildPrompt(area, grado, nombre, baseText, nota, nivel, fechaISO){
      const dba = getDBA(area, grado);

      return (
`Eres un docente colombiano experto en currículo MEN. Tu salida debe ser SOLO un JSON válido (sin Markdown, sin comillas triples, sin texto antes o después).

Reglas estrictas:
- Devuelve un único objeto JSON.
- No incluyas caracteres fuera del JSON.
- Usa español.
- No dejes listas vacías: si algo no aplica, escribe una alternativa breve.
- Rúbrica: exactamente 4 criterios y cada criterio con exactamente 4 niveles.
- Evaluación sumativa: exactamente 10 preguntas con clave.
- Ejercicios graduados: exactamente 10 ítems con respuesta.
- Problemas combinados: exactamente 5 ítems con solución breve.

Contexto:
- Área: ${area}
- Grado: ${grado}
- Estudiante: ${nombre || "_____"}
- Nota: ${nota || "-"}
- Nivel: ${nivel || "Sin nota"}
- Fecha: ${fechaISO}

DBA referencia (síntesis):
${dba.map(x=>`- ${x}`).join("\n")}

Texto base del docente:
${baseText || "(sin base)"}

Esquema JSON obligatorio:
{
  "version":"1.0",
  "meta":{
    "estudiante":"${nombre || "_____"}",
    "grado":"${grado}",
    "area":"${area}",
    "nota":"${nota || "-"}",
    "nivel":"${nivel || "Sin nota"}",
    "fecha":"${fechaISO}"
  },
  "dba":[ "...", "...", "...", "...", "..." ],
  "diagnostico":{
    "queNoSeLogro":[ "...", "..." ],
    "evidencias":[ "...", "..." ]
  },
  "propositoRecuperacion":"...",
  "secuenciaDidactica":[ "Paso 1...", "Paso 2...", "Paso 3...", "Paso 4...", "Paso 5..." ],
  "materialPractico":{
    "ejerciciosGraduados":[
      {"id":1,"enunciado":"...","respuesta":"..."}
    ],
    "tallerAplicado":{
      "titulo":"...",
      "contexto":"familia/escuela/comunidad en Colombia",
      "instrucciones":[ "...", "..." ],
      "insumos":[ "...", "..." ],
      "productoFinal":"..."
    },
    "problemasCombinados":[
      {"id":1,"enunciado":"...","solucionBreve":"..."}
    ],
    "retoCreativo":{
      "titulo":"...",
      "descripcion":"...",
      "pasos":[ "...", "..." ],
      "evidencia":"..."
    }
  },
  "evaluacionFormativa":{
    "criterios":[
      {"criterio":"...","niveles":[
        {"nivel":"1","descriptor":"..."},
        {"nivel":"2","descriptor":"..."},
        {"nivel":"3","descriptor":"..."},
        {"nivel":"4","descriptor":"..."}
      ]},
      {"criterio":"...","niveles":[{"nivel":"1","descriptor":"..."},{"nivel":"2","descriptor":"..."},{"nivel":"3","descriptor":"..."},{"nivel":"4","descriptor":"..."}]},
      {"criterio":"...","niveles":[{"nivel":"1","descriptor":"..."},{"nivel":"2","descriptor":"..."},{"nivel":"3","descriptor":"..."},{"nivel":"4","descriptor":"..."}]},
      {"criterio":"...","niveles":[{"nivel":"1","descriptor":"..."},{"nivel":"2","descriptor":"..."},{"nivel":"3","descriptor":"..."},{"nivel":"4","descriptor":"..."}]}
    ]
  },
  "evaluacionSumativa":{
    "preguntas":[
      {"id":1,"tipo":"seleccion_multiple|abierta|verdadero_falso","enunciado":"...","opciones":["A) ...","B) ...","C) ...","D) ..."],"respuesta":"..."}
    ]
  },
  "adaptacionesNEAE":[ "...", "..." ],
  "materialesYTiempo":{
    "materiales":[ "...", "..." ],
    "tiempoEstimadoMinutos":120,
    "sesionesSugeridas":"..."
  },
  "criteriosSuperacion":{
    "notaMinima":3.3,
    "evidenciasAEntregar":[ "...", "..." ]
  }
}`
      );
    }

    // ======= IA OFFLINE (JSON con mismo esquema) =======
    function offlineJSON(area, grado, nombre, nota, nivel){
      const dba = getDBA(area, grado);

      function mk10(prefix){
        const out = [];
        for(let i=1;i<=10;i++){
          out.push({id:i, enunciado:`${prefix} ${i}`, respuesta:`Respuesta ${i}`});
        }
        return out;
      }
      function mk5(prefix){
        const out = [];
        for(let i=1;i<=5;i++){
          out.push({id:i, enunciado:`${prefix} ${i} (2–3 pasos)`, solucionBreve:`Solución breve ${i}`});
        }
        return out;
      }
      function rubric(){
        return [
          {criterio:"Comprensión conceptual", niveles:[
            {nivel:"1", descriptor:"Muestra confusión frecuente y requiere guía permanente."},
            {nivel:"2", descriptor:"Reconoce conceptos con apoyo y ejemplos."},
            {nivel:"3", descriptor:"Aplica conceptos en ejercicios habituales con pocos errores."},
            {nivel:"4", descriptor:"Explica y aplica conceptos en situaciones nuevas con claridad."}
          ]},
          {criterio:"Procedimiento y estrategia", niveles:[
            {nivel:"1", descriptor:"No sigue pasos o los aplica al azar."},
            {nivel:"2", descriptor:"Sigue pasos con apoyo, pero omite verificaciones."},
            {nivel:"3", descriptor:"Sigue un procedimiento adecuado y verifica parcialmente."},
            {nivel:"4", descriptor:"Selecciona estrategias, verifica y justifica decisiones."}
          ]},
          {criterio:"Comunicación", niveles:[
            {nivel:"1", descriptor:"Respuestas incompletas o poco legibles."},
            {nivel:"2", descriptor:"Comunica ideas básicas con apoyo de formatos."},
            {nivel:"3", descriptor:"Comunica con orden y vocabulario apropiado."},
            {nivel:"4", descriptor:"Comunica con precisión, ejemplos y buen uso de conectores."}
          ]},
          {criterio:"Autonomía y presentación", niveles:[
            {nivel:"1", descriptor:"Depende totalmente del docente y presenta trabajos incompletos."},
            {nivel:"2", descriptor:"Avanza con recordatorios y entrega parcialmente."},
            {nivel:"3", descriptor:"Trabaja con autonomía y entrega completo."},
            {nivel:"4", descriptor:"Gestiona tiempo, mejora y entrega evidencias de alta calidad."}
          ]}
        ];
      }

      const fechaISO = formatDateISO(new Date());

      // 10 preguntas sumativa (mezcla de tipos)
      const preguntas = Array.from({length:10}, (_,i)=>({
        id:i+1,
        tipo: (i%3===0) ? "seleccion_multiple" : (i%3===1) ? "verdadero_falso" : "abierta",
        enunciado:`Pregunta ${i+1} sobre ${area} (grado ${grado}).`,
        opciones: (i%3===0) ? ["A) Opción A","B) Opción B","C) Opción C","D) Opción D"] : [],
        respuesta: (i%3===0) ? "A" : (i%3===1) ? "Verdadero" : "Respuesta modelo breve"
      }));

      return {
        version:"1.0",
        meta:{
          estudiante: nombre || "_____",
          grado: String(grado),
          area: String(area),
          nota: nota || "-",
          nivel: nivel || "Sin nota",
          fecha: fechaISO
        },
        dba: dba,
        diagnostico:{
          queNoSeLogro:["Presenta dificultades en los temas priorizados.","Evidencia errores recurrentes en actividades previas."],
          evidencias:["Talleres incompletos o con baja precisión.","Resultados bajos en evaluación o actividades de clase."]
        },
        propositoRecuperacion:"Fortalecer desempeños clave del área a partir de práctica guiada, aplicación contextual y evaluación con retroalimentación.",
        secuenciaDidactica:["Diagnóstico rápido (3 ítems).","Recuperación conceptual breve.","Práctica guiada con ejemplos.","Práctica independiente (taller).","Reevaluación y reflexión final."],
        materialPractico:{
          ejerciciosGraduados: mk10("Ejercicio graduado"),
          tallerAplicado:{
            titulo:`Taller aplicado: ${area}`,
            contexto:"familia/escuela/comunidad en Colombia",
            instrucciones:["Lee la guía y revisa un ejemplo resuelto.","Resuelve los ejercicios y justifica tus respuestas.","Socializa un resultado con un familiar o compañero y escribe una conclusión."],
            insumos:["Cuaderno","Lápiz","Regla (si aplica)","Celular (opcional para consulta guiada)"],
            productoFinal:"Taller resuelto, con procedimiento y una breve reflexión."
          },
          problemasCombinados: mk5("Problema combinado"),
          retoCreativo:{
            titulo:"Reto creativo",
            descripcion:"Crea un producto sencillo (afiche, infografía o mini-guía) que explique el tema con un ejemplo de tu entorno.",
            pasos:["Elige un tema del diagnóstico.","Crea el producto con un ejemplo real.","Incluye 3 ideas clave y 1 recomendación.","Entrega foto o archivo."],
            evidencia:"Foto o PDF del producto final."
          }
        },
        evaluacionFormativa:{ criterios: rubric() },
        evaluacionSumativa:{ preguntas },
        adaptacionesNEAE:["Instrucciones por pasos y ejemplo resuelto.","Tiempo adicional y apoyos visuales (tablas, organizadores)."],
        materialesYTiempo:{
          materiales:["Guía impresa o digital","Cuaderno","Útiles escolares"],
          tiempoEstimadoMinutos:120,
          sesionesSugeridas:"2 sesiones de 60 minutos"
        },
        criteriosSuperacion:{
          notaMinima:3.3,
          evidenciasAEntregar:["Taller aplicado resuelto","Ejercicios graduados completos","Evaluación sumativa con clave y corrección"]
        }
      };
    }

    // ======= Render JSON -> HTML (mejor salida en pantalla) =======
    function esc(s){
      return String(s ?? "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }
    function renderList(items){
      const arr = Array.isArray(items) ? items : [];
      if(!arr.length) return "<p class='small'>Sin datos.</p>";
      return "<ul>" + arr.map(x=>`<li>${esc(x)}</li>`).join("") + "</ul>";
    }
    function renderPlanJSON(data){
      const meta = data?.meta || {};
      const diag = data?.diagnostico || {};
      const mp = data?.materialPractico || {};
      const ta = mp?.tallerAplicado || {};
      const rc = mp?.retoCreativo || {};
      const rub = data?.evaluacionFormativa?.criterios || [];
      const sum = data?.evaluacionSumativa?.preguntas || [];
      const myt = data?.materialesYTiempo || {};
      const cs = data?.criteriosSuperacion || {};

      const rubricRows = (Array.isArray(rub) ? rub : []).map(c=>{
        const lv = Array.isArray(c?.niveles) ? c.niveles : [];
        const get = n => (lv.find(x=>String(x.nivel)===String(n))?.descriptor) || "";
        return `<tr>
          <td>${esc(c?.criterio || "")}</td>
          <td>${esc(get("1"))}</td>
          <td>${esc(get("2"))}</td>
          <td>${esc(get("3"))}</td>
          <td>${esc(get("4"))}</td>
        </tr>`;
      }).join("");

      const preguntasHTML = (Array.isArray(sum) ? sum : []).map(q=>{
        const opts = Array.isArray(q?.opciones) ? q.opciones : [];
        return `<div class="q">
          <div class="t">(${esc(q?.tipo || "")})</div>
          <div>${esc(q?.id)}. ${esc(q?.enunciado || "")}</div>
          ${opts.length ? ("<ul>"+opts.map(o=>`<li>${esc(o)}</li>`).join("")+"</ul>") : ""}
          <div class="t">Clave: ${esc(q?.respuesta || "")}</div>
        </div>`;
      }).join("");

      const ejerciciosHTML = (Array.isArray(mp?.ejerciciosGraduados) ? mp.ejerciciosGraduados : []).map(it=>{
        return `<div class="q">
          <div>${esc(it?.id)}. ${esc(it?.enunciado || "")}</div>
          <div class="t">Respuesta: ${esc(it?.respuesta || "")}</div>
        </div>`;
      }).join("");

      const problemasHTML = (Array.isArray(mp?.problemasCombinados) ? mp.problemasCombinados : []).map(it=>{
        return `<div class="q">
          <div>${esc(it?.id)}. ${esc(it?.enunciado || "")}</div>
          <div class="t">Solución breve: ${esc(it?.solucionBreve || "")}</div>
        </div>`;
      }).join("");

      return `<div class="plan">
        <h3>Datos</h3>
        <div class="kv">
          <div class="t">Estudiante</div><div>${esc(meta.estudiante||"")}</div>
          <div class="t">Grado / Área</div><div>${esc(meta.grado||"")} / ${esc(meta.area||"")}</div>
          <div class="t">Nota / Nivel</div><div>${esc(meta.nota||"")} / ${esc(meta.nivel||"")}</div>
          <div class="t">Fecha</div><div>${esc(meta.fecha||"")}</div>
        </div>

        <h3>DBA de referencia</h3>
        ${renderList(data?.dba)}

        <h3>Diagnóstico</h3>
        <h4>Qué no se logró</h4>
        ${renderList(diag.queNoSeLogro)}
        <h4>Evidencias</h4>
        ${renderList(diag.evidencias)}

        <h3>Propósito de recuperación</h3>
        <p>${esc(data?.propositoRecuperacion || "")}</p>

        <h3>Secuencia didáctica</h3>
        ${renderList(data?.secuenciaDidactica)}

        <h3>Material práctico</h3>
        <h4>Ejercicios graduados (10)</h4>
        ${ejerciciosHTML || "<p class='small'>Sin datos.</p>"}

        <h4>Taller aplicado</h4>
        <div class="kv">
          <div class="t">Título</div><div>${esc(ta.titulo||"")}</div>
          <div class="t">Contexto</div><div>${esc(ta.contexto||"")}</div>
          <div class="t">Producto final</div><div>${esc(ta.productoFinal||"")}</div>
          <div class="t">Insumos</div><div>${esc((ta.insumos||[]).join(", "))}</div>
        </div>
        <h4>Instrucciones</h4>
        ${renderList(ta.instrucciones)}

        <h4>Problemas combinados (5)</h4>
        ${problemasHTML || "<p class='small'>Sin datos.</p>"}

        <h4>Reto creativo</h4>
        <div class="kv">
          <div class="t">Título</div><div>${esc(rc.titulo||"")}</div>
          <div class="t">Descripción</div><div>${esc(rc.descripcion||"")}</div>
          <div class="t">Evidencia</div><div>${esc(rc.evidencia||"")}</div>
        </div>
        <h4>Pasos</h4>
        ${renderList(rc.pasos)}

        <h3>Evaluación formativa</h3>
        <h4>Rúbrica (4×4)</h4>
        <table>
          <thead>
            <tr>
              <th>Criterio</th>
              <th>Nivel 1</th>
              <th>Nivel 2</th>
              <th>Nivel 3</th>
              <th>Nivel 4</th>
            </tr>
          </thead>
          <tbody>
            ${rubricRows || "<tr><td colspan='5'>Sin rúbrica.</td></tr>"}
          </tbody>
        </table>

        <h3>Evaluación sumativa (10) con clave</h3>
        ${preguntasHTML || "<p class='small'>Sin preguntas.</p>"}

        <h3>Adaptaciones NEAE</h3>
        ${renderList(data?.adaptacionesNEAE)}

        <h3>Materiales y tiempo</h3>
        <div class="kv">
          <div class="t">Materiales</div><div>${esc((myt.materiales||[]).join(", "))}</div>
          <div class="t">Tiempo estimado</div><div>${esc(myt.tiempoEstimadoMinutos||"")} minutos</div>
          <div class="t">Sesiones sugeridas</div><div>${esc(myt.sesionesSugeridas||"")}</div>
        </div>

        <h3>Criterios de superación</h3>
        <div class="kv">
          <div class="t">Nota mínima</div><div>${esc(cs.notaMinima||"3.3")}</div>
          <div class="t">Evidencias a entregar</div><div>${esc((cs.evidenciasAEntregar||[]).join(", "))}</div>
        </div>
      </div>`;
    }

    // ======= IA: un click =======
    btnIA.onclick = async () => {
      const base = elSalida.textContent.trim();
      const area = elArea.value, grado = elGrado.value, nombre = elNombre.value.trim();
      const nota = elNota.value ? String(elNota.value) : "-";
      const c = clasificarNota(parseFloat(elNota.value));
      const nivel = c.nivel;
      const fechaISO = formatDateISO(new Date());

      const prompt = buildPrompt(area, grado, nombre, base, nota, nivel, fechaISO);

      elIA.innerHTML = "<span class='muted'>Generando materiales con IA…</span>";
      iaData = null;

      try{
        let txt = "";
        if(online){
          const prov = elProv.value;
          const model = elModelo.value.trim();
          const key = elApiKey.value.trim();
          if(!key){
            elIA.innerHTML = "<span class='muted'>Falta la API key para modo online. Cambia a modo offline o ingrésala.</span>";
            return;
          }
          txt = (prov==="gemini")
            ? await callGemini(key, model, prompt)
            : await callOpenAI(key, model, prompt);
        } else {
          // Offline produce directamente el objeto (sin modelo)
          iaData = offlineJSON(area, grado, nombre, nota, nivel);
          elIA.innerHTML = renderPlanJSON(iaData);
          btnPDFIA.disabled = false;
          return;
        }

        const ctx = { online:true, prov: elProv.value, key: elApiKey.value.trim(), model: elModelo.value.trim() };
        const data = await parseJsonWithAutoFix(txt, ctx);
        iaData = data;

        elIA.innerHTML = renderPlanJSON(data);
        btnPDFIA.disabled = false;
      }catch(e){
        elIA.textContent = "Error: " + e.message;
        btnPDFIA.disabled = true;
      }
    };
// ======= PDF IA desde JSON (mejor salida) =======
    btnPDFIA.onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4" });

      if(!iaData){
        doc.text("Sin contenido IA en JSON.", 15, 20);
        doc.save("plan_mejoramiento_IA_DBA.pdf");
        return;
      }

      const pageWidth  = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const marginX = 15;
      const marginY = 18;
      const maxWidth = pageWidth - 2 * marginX;

      let y = marginY;

      function ensureSpace(h){
        if(y + h > pageHeight - marginY){
          doc.addPage();
          y = marginY;
        }
      }

      function writeTitle(text){
        doc.setFont("helvetica","normal");
        doc.setFontSize(14);
        const lines = doc.splitTextToSize(String(text||""), maxWidth);
        ensureSpace(lines.length*7);
        doc.text(lines, marginX, y);
        y += lines.length*7 + 2;
      }

      function writeH(text){
        doc.setFont("helvetica","normal");
        doc.setFontSize(12);
        const lines = doc.splitTextToSize(String(text||""), maxWidth);
        ensureSpace(lines.length*6);
        doc.text(lines, marginX, y);
        y += lines.length*6 + 1;
      }

      function writeP(text){
        doc.setFont("helvetica","normal");
        doc.setFontSize(10.5);
        const lines = doc.splitTextToSize(String(text||""), maxWidth);
        ensureSpace(lines.length*5.2);
        doc.text(lines, marginX, y);
        y += lines.length*5.2 + 1;
      }

      function writeList(items){
        const arr = Array.isArray(items) ? items : [];
        doc.setFont("helvetica","normal");
        doc.setFontSize(10.5);
        for(const it of arr){
          const bullet = "• " + String(it||"");
          const lines = doc.splitTextToSize(bullet, maxWidth);
          ensureSpace(lines.length*5.2);
          doc.text(lines, marginX, y);
          y += lines.length*5.2;
        }
        y += 1.5;
      }

      function writeNumbered(items){
        const arr = Array.isArray(items) ? items : [];
        doc.setFont("helvetica","normal");
        doc.setFontSize(10.5);
        arr.forEach((it, idx)=>{
          const t = `${idx+1}. ${String(it||"")}`;
          const lines = doc.splitTextToSize(t, maxWidth);
          ensureSpace(lines.length*5.2);
          doc.text(lines, marginX, y);
          y += lines.length*5.2;
        });
        y += 1.5;
      }

      function writeRubricTable(criteria){
        const rub = Array.isArray(criteria) ? criteria : [];
        if(!rub.length) return;

        const colW = [30, 37, 37, 37, 37];
        const x0 = marginX;

        const header = ["Criterio","Nivel 1","Nivel 2","Nivel 3","Nivel 4"];
        const lh = 5;
        const pad = 2.2;

        doc.setFont("helvetica","normal");
        doc.setFontSize(9.5);

        function cellLines(text, w){
          return doc.splitTextToSize(String(text||""), w - pad*2);
        }

        function rowHeight(cells){
          const linesCount = cells.map((c,i)=>cellLines(c, colW[i]).length);
          const maxLines = Math.max(...linesCount, 1);
          return maxLines*lh + pad*2;
        }

        function drawRow(cells, h){
          ensureSpace(h + 2);
          let x = x0;
          for(let i=0;i<cells.length;i++){
            doc.rect(x, y, colW[i], h);
            const lines = cellLines(cells[i], colW[i]);
            doc.text(lines, x + pad, y + pad + lh - 1);
            x += colW[i];
          }
          y += h;
        }

        const hH = rowHeight(header);
        drawRow(header, hH);

        rub.forEach(c=>{
          const lv = Array.isArray(c?.niveles) ? c.niveles : [];
          const get = n => lv.find(x=>String(x.nivel)===String(n))?.descriptor || "";
          const row = [ c?.criterio || "", get(1), get(2), get(3), get(4) ];
          const h = rowHeight(row);
          drawRow(row, h);
        });

        y += 3;
      }

      // ===== Contenido PDF desde JSON =====
      writeTitle("Plan de Mejoramiento (DBA MEN) - Generado por IA");

      const meta = iaData.meta || {};
      writeH("Datos");
      writeList([
        `Estudiante: ${meta.estudiante || ""}`,
        `Grado: ${meta.grado || ""} | Área: ${meta.area || ""}`,
        `Nota: ${meta.nota || ""} | Nivel: ${meta.nivel || ""}`,
        `Fecha: ${meta.fecha || ""}`
      ]);

      writeH("DBA de referencia");
      writeList(iaData.dba);

      writeH("Diagnóstico");
      writeP("Qué no se logró:");
      writeList(iaData.diagnostico?.queNoSeLogro);
      writeP("Evidencias:");
      writeList(iaData.diagnostico?.evidencias);

      writeH("Propósito de recuperación");
      writeP(iaData.propositoRecuperacion);

      writeH("Secuencia didáctica");
      writeNumbered(iaData.secuenciaDidactica);

      writeH("Material práctico - Ejercicios graduados (10)");
      (iaData.materialPractico?.ejerciciosGraduados || []).forEach(it=>{
        writeP(`${it.id}. ${it.enunciado}`);
        writeP(`Respuesta: ${it.respuesta}`);
        y += 1;
      });

      writeH("Material práctico - Taller aplicado");
      const ta = iaData.materialPractico?.tallerAplicado || {};
      writeList([
        `Título: ${ta.titulo || ""}`,
        `Contexto: ${ta.contexto || ""}`,
        `Insumos: ${(ta.insumos || []).join(", ")}`,
        `Producto final: ${ta.productoFinal || ""}`
      ]);
      writeP("Instrucciones:");
      writeNumbered(ta.instrucciones);

      writeH("Material práctico - Problemas combinados (5)");
      (iaData.materialPractico?.problemasCombinados || []).forEach(it=>{
        writeP(`${it.id}. ${it.enunciado}`);
        writeP(`Solución breve: ${it.solucionBreve}`);
        y += 1;
      });

      writeH("Material práctico - Reto creativo");
      const rc = iaData.materialPractico?.retoCreativo || {};
      writeList([
        `Título: ${rc.titulo || ""}`,
        `Descripción: ${rc.descripcion || ""}`,
        `Evidencia: ${rc.evidencia || ""}`
      ]);
      writeP("Pasos:");
      writeNumbered(rc.pasos);

      writeH("Evaluación formativa - Rúbrica 4×4");
      writeRubricTable(iaData.evaluacionFormativa?.criterios);

      writeH("Evaluación sumativa (10) con clave");
      (iaData.evaluacionSumativa?.preguntas || []).forEach(q=>{
        writeP(`${q.id}. (${q.tipo}) ${q.enunciado}`);
        if(Array.isArray(q.opciones) && q.opciones.length){
          writeList(q.opciones);
        }
        writeP(`Clave: ${q.respuesta}`);
        y += 1;
      });

      writeH("Adaptaciones NEAE");
      writeList(iaData.adaptacionesNEAE);

      writeH("Materiales y tiempo");
      const myt = iaData.materialesYTiempo || {};
      writeList([
        `Materiales: ${(myt.materiales || []).join(", ")}`,
        `Tiempo estimado: ${myt.tiempoEstimadoMinutos || ""} minutos`,
        `Sesiones sugeridas: ${myt.sesionesSugeridas || ""}`
      ]);

      writeH("Criterios de superación");
      const cs = iaData.criteriosSuperacion || {};
      writeList([
        `Nota mínima: ${cs.notaMinima}`,
        `Evidencias a entregar: ${(cs.evidenciasAEntregar || []).join(", ")}`
      ]);

      // Footer con numeración
      const pageCount = doc.internal.getNumberOfPages();
      doc.setFontSize(9.5);
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text(`Página ${i} de ${pageCount}`, pageWidth - marginX, pageHeight - 10, { align: "right" });
      }

      doc.save("plan_mejoramiento_IA_DBA.pdf");
    };
  </script>
</body>
</html>